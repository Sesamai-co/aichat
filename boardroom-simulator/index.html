<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Boardroom Simulator v2</title>
    <style>
        :root {
            --navy: #0a192f; --navy-light: #172a45; --gold: #ffc107; --white: #e6f1ff; 
            --slate: #8892b0; --danger: #ff5555; --success: #64ffda;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--navy); color: var(--slate); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Header */
        header { padding: 1rem 2rem; background: var(--navy-light); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .brand { color: var(--white); font-weight: bold; font-size: 1.2rem; }
        .api-input-group { display: flex; gap: 10px; align-items: center; }
        #api-key { background: #0b1421; border: 1px solid var(--slate); color: white; padding: 5px 10px; border-radius: 4px; width: 200px; }

        /* Main Layout */
        main { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; padding: 2rem; height: 100%; box-sizing: border-box; }
        
        .card { background: var(--navy-light); border-radius: 8px; padding: 1.5rem; display: flex; flex-direction: column; border: 1px solid #333; }
        h2 { color: var(--white); border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; }

        /* Scenario */
        .scenario-box { background: rgba(255, 255, 255, 0.05); padding: 10px; margin-bottom: 20px; border-left: 3px solid var(--gold); color: var(--white); }

        /* Transcript */
        .transcript-area { flex: 1; background: #000; padding: 1rem; border: 1px solid #333; font-family: monospace; color: var(--success); overflow-y: auto; margin-bottom: 20px; font-size: 1rem; }

        /* Controls - The New UX */
        .control-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        button { border: none; padding: 15px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; color: var(--navy); }
        
        #btn-record { background: var(--slate); color: var(--navy); }
        #btn-record.recording { background: var(--danger); color: white; animation: pulse 1.5s infinite; }
        
        #btn-analyze { background: var(--gold); opacity: 0.5; pointer-events: none; }
        #btn-analyze.ready { opacity: 1; pointer-events: all; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Status Bar */
        #status-bar { margin-top: 15px; text-align: center; color: var(--white); font-weight: bold; min-height: 24px; }

        /* Dashboard (Right Side) */
        .metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .metric { background: rgba(255,255,255,0.05); padding: 20px; text-align: center; border-radius: 6px; }
        .metric-val { font-size: 2.5rem; font-weight: bold; color: var(--white); }
        .metric-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }

        .feedback-box { margin-bottom: 15px; }
        .feedback-label { color: var(--gold); font-size: 0.8rem; font-weight: bold; display: block; margin-bottom: 5px; }
        .rewrite { background: rgba(100, 255, 218, 0.1); border: 1px solid var(--success); color: var(--success); padding: 10px; margin-top: 5px; }

        .hidden { display: none; }
        .error-msg { color: var(--danger); border: 1px solid var(--danger); padding: 10px; margin-top: 10px; background: rgba(255,0,0,0.1); }
    </style>
</head>
<body>

    <header>
        <div class="brand">BOARDROOM SIMULATOR v2</div>
        <div class="api-input-group">
            <span style="font-size: 0.8rem; color: var(--slate);">OPENAI API KEY:</span>
            <input type="password" id="api-key" placeholder="sk-..." onchange="saveKey()">
        </div>
    </header>

    <main>
        <div class="card">
            <h2>The Situation</h2>
            <div class="scenario-box">
                <strong>Scenario:</strong> <span id="scenario-text">Critical Database Outage causing 404 errors for 20% of users. CEO is asking for an update.</span>
                <br><br>
                <small style="color: var(--slate); cursor: pointer; text-decoration: underline;" onclick="newScenario()">üîÑ Randomize</small>
            </div>

            <div class="transcript-area" id="transcript">
                Press RECORD to start speaking...
            </div>

            <div class="control-bar">
                <button id="btn-record" onclick="toggleMic()">‚óè START RECORDING</button>
                <button id="btn-analyze" onclick="analyze()" disabled>‚û§ STOP & ANALYZE</button>
            </div>
            <div id="status-bar">Ready</div>
        </div>

        <div class="card">
            <h2>Executive Feedback</h2>
            
            <div id="loader" class="hidden" style="text-align: center; padding: 50px;">
                <div style="font-size: 3rem;">‚öôÔ∏è</div>
                <p>Consulting the CFO...</p>
            </div>

            <div id="dashboard" class="hidden">
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-val" id="score">--</div>
                        <div class="metric-label">Brevity</div>
                    </div>
                    <div class="metric">
                        <div class="metric-val" id="grade">--</div>
                        <div class="metric-label">Impact</div>
                    </div>
                </div>
                
                <div class="feedback-box">
                    <span class="feedback-label">RUTHLESS CRITIQUE</span>
                    <div id="critique" style="color: var(--white);">--</div>
                </div>
                
                <div class="feedback-box">
                    <span class="feedback-label">BETTER VERSION (BLUF)</span>
                    <div id="rewrite" class="rewrite">--</div>
                </div>
            </div>

            <div id="error-box" class="hidden error-msg"></div>
        </div>
    </main>

    <script>
        // --- State ---
        let recognition;
        let isRecording = false;
        let finalTranscript = "";
        
        // --- Elements ---
        const btnRecord = document.getElementById('btn-record');
        const btnAnalyze = document.getElementById('btn-analyze');
        const statusBar = document.getElementById('status-bar');
        const transcriptEl = document.getElementById('transcript');
        const apiKeyInput = document.getElementById('api-key');
        
        // --- Initialization ---
        if(localStorage.getItem('boardroom_api_key')) {
            apiKeyInput.value = localStorage.getItem('boardroom_api_key');
        }

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = () => {
                statusBar.innerText = "Listening...";
                statusBar.style.color = "#ff5555";
            };

            recognition.onresult = (event) => {
                let interim = "";
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + " ";
                    } else {
                        interim += event.results[i][0].transcript;
                    }
                }
                transcriptEl.innerHTML = `<span style="color:white">${finalTranscript}</span><span style="color:#666">${interim}</span>`;
            };

            recognition.onerror = (e) => {
                statusBar.innerText = "Mic Error: " + e.error;
                stopMicUI();
            };
        } else {
            transcriptEl.innerText = "ERROR: Browser not supported. Use Chrome Desktop.";
            btnRecord.disabled = true;
        }

        // --- Functions ---

        function saveKey() {
            localStorage.setItem('boardroom_api_key', apiKeyInput.value);
            statusBar.innerText = "API Key Saved.";
            statusBar.style.color = "#64ffda";
        }

        function toggleMic() {
            if(!isRecording) {
                // Start
                finalTranscript = ""; 
                transcriptEl.innerHTML = "";
                recognition.start();
                isRecording = true;
                
                btnRecord.innerText = "‚ñ† STOP RECORDING";
                btnRecord.classList.add('recording');
                
                btnAnalyze.disabled = false;
                btnAnalyze.classList.add('ready');
            } else {
                // Stop (Pause)
                recognition.stop();
                stopMicUI();
            }
        }

        function stopMicUI() {
            isRecording = false;
            btnRecord.innerText = "‚óè RE-RECORD";
            btnRecord.classList.remove('recording');
            statusBar.innerText = "Recording paused. Press Analyze when ready.";
            statusBar.style.color = "var(--white)";
        }

        function newScenario() {
            const scenarios = [
                "The mobile app login is down for iOS users.",
                "We need to hire 5 more engineers but have 0 budget.",
                "The project is delayed by 2 months due to technical debt."
            ];
            document.getElementById('scenario-text').innerText = scenarios[Math.floor(Math.random() * scenarios.length)];
        }

        async function analyze() {
            // UI Reset
            if(isRecording) recognition.stop();
            stopMicUI();
            
            const key = apiKeyInput.value;
            const text = transcriptEl.innerText;
            
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('error-box').classList.add('hidden');
            document.getElementById('loader').classList.remove('hidden');
            statusBar.innerText = "Sending to OpenAI...";

            // Validation
            if(!text || text.length < 5) {
                showError("Transcript too short. Please speak more.");
                return;
            }

            try {
                // MODE SELECTION: If Key exists, use Live. If not, use Demo.
                let data;
                if(key && key.startsWith('sk-')) {
                    data = await callOpenAI(text, key);
                } else {
                    console.log("No Key detected, using Mock Data");
                    await new Promise(r => setTimeout(r, 1500)); // Fake delay
                    data = getMockData();
                }
                
                renderDashboard(data);
                statusBar.innerText = "Analysis Complete.";

            } catch (err) {
                showError(err.message);
            }
        }

        async function callOpenAI(text, key) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${key}`
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [
                        {role: "system", content: "You are a ruthless CFO. Output JSON: {brevity_score: number, grade: string, feedback: string, rewrite: string}. Grade harshly."},
                        {role: "user", content: `Context: ${document.getElementById('scenario-text').innerText}. Transcript: ${text}`}
                    ],
                    response_format: { type: "json_object" }
                })
            });

            if(!response.ok) {
                const errData = await response.json();
                throw new Error("OpenAI Error: " + (errData.error?.message || response.statusText));
            }

            const json = await response.json();
            return JSON.parse(json.choices[0].message.content);
        }

        function getMockData() {
            return {
                brevity_score: 65,
                grade: "C-",
                feedback: "DEMO MODE: You used too many filler words. Enter an API Key for real analysis.",
                rewrite: "Project is delayed. Mitigation plan attached. (Demo Output)"
            };
        }

        function renderDashboard(data) {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            document.getElementById('score').innerText = data.brevity_score;
            document.getElementById('grade').innerText = data.grade;
            document.getElementById('critique').innerText = data.feedback;
            document.getElementById('rewrite').innerText = data.rewrite;
            
            // Color logic
            const gradeEl = document.getElementById('grade');
            if(data.grade.includes('A')) gradeEl.style.color = "var(--success)";
            else if(data.grade.includes('F') || data.grade.includes('D')) gradeEl.style.color = "var(--danger)";
            else gradeEl.style.color = "var(--gold)";
        }

        function showError(msg) {
            document.getElementById('loader').classList.add('hidden');
            const errBox = document.getElementById('error-box');
            errBox.innerText = "‚ö†Ô∏è " + msg;
            errBox.classList.remove('hidden');
            statusBar.innerText = "Analysis Failed";
            statusBar.style.color = "var(--danger)";
        }
    </script>
</body>
</html>